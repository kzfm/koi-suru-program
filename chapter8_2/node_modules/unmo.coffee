responder = require('responder')
Dictionary = require('dictionary').Dictionary
Emotion = require('emotion').Emotion
Morph = require('morph').Morph
util = require('util')

exports.Unmo = class Unmo
  constructor: (@name) ->
    @dictionary = new Dictionary()
    @emotion = new Emotion(@dictionary)
    @morph = new Morph()

    @resp_random = new responder.RandomResponder('Random',@dictionary)
    @resp_what = new responder.WhatResponder('What')
    @resp_pattern = new responder.PatternResponder('Pattern', @dictionary)
    @resp_template = new responder.TemplateResponder('Template', @dictionary)
    @responder = @resp_pattern

  responder_name: () -> @responder.name
  mood: () -> @emotion.mood

  dialogue: (input, callback) =>
    @emotion.update(input)
    @morph.analyze input, (err, result) =>
      parts = result
      rand = Math.floor(Math.random() * 100)
      if rand >= 0 and rand < 40
        @responder = @resp_pattern
      else if rand < 70
        @responder = @resp_template
      else if rand < 90
        @responder = @resp_random
      else
        @resp_random = @resp_what
      resp = @responder.response(input, parts, @emotion.mood)
      @dictionary.study(input, parts)
      if input is 'save'
        @dictionary.save()
        callback(null, 'saveしたよ！')
      else
        callback(null, resp)

  save: ->
    @dictionary.save()
